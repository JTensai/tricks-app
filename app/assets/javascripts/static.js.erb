jQuery(function() {
  const images = [
    '<%= image_url "site_header_images/Folsom/IMG_7786.jpg" %>',
    '<%= image_url "site_header_images/Folsom/IMG_7790.jpg" %>',
    '<%= image_url "site_header_images/Folsom/IMG_7792.jpg" %>',
    '<%= image_url "site_header_images/Sacramento/IMG_7840.jpg" %>',
    '<%= image_url "site_header_images/Sacramento/IMG_7839.jpg" %>',
    '<%= image_url "site_header_images/Sacramento/IMG_7827.jpg" %>'
  ]
  
  /*
  * Preload an image if not cached, then call a callback function
  * @param {String} the image url
  * @param {Function} the callback function
  */
  async function loadImg(url, fn) {
    var img = new Image();
    img.src = url;
    if (img.complete) { // If the image has been cached, just call the callback
      // console.log("Already downloaded.");
      if (fn) fn(img);
    } else {
      img.onerror = function() { // If fail to load the image
        // console.log("Failed to download");
        if (fn) fn(img);
      };
      img.onload = function() { // If loaded successfully
        // console.log("Done downloading");
        if (fn) fn(img);
        //On IE6, multiple frames in a image will fire the 'onload' event for multiple times. So set to null
        img.onload = null; 
      };
    };
  }

  let i = 0;
  const swap = async function(image) {
    $('#background_images').fadeOut(500, () => {
      $('#background_images').css('background-image', "url("+images[i]+")");
      $('#background_images').fadeIn(1000, () => {
        setTimeout(() => {
          loadImg(images[i], swap);
          i = i + 1;
          if (i === images.length) {
            i = 0;
          }
        }, 5000);
      });
    });
  };

  const updateOrbitSize = async function() {
    $('.orbit-container').each(function(i, obj) {
      $(this).height($(this).width() * (320 / 570) + 39 + "px");
    });
  };

  const updateBlueBar = async function() {
    var bottom;
    $('#blue_bar').height($('#blue_bar').parent().height());
    bottom = $(window).height() - ($('#blue_bar').position().top + $('#blue_bar').outerHeight(true));
    $('#background_images').css({
      bottom: bottom + "px"
    });
  };

  $(document).ready(function() {
    loadImg(images[i], swap);
    updateOrbitSize();
    updateBlueBar();
  });
  
  $(window).resize(function() {
    updateOrbitSize();
    updateBlueBar();
  });
});